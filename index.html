<!DOCTYPE html>
<html lang="uz" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ultra Smart Anki 2025</title>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Konfiguratsiya -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 
                            dark: '#050505', 
                            card: '#121212', 
                            border: '#2A2A2A', 
                            blue: '#2997FF', 
                            success: '#30D158',
                            warning: '#FF9F0A',
                            danger: '#FF453A'
                        }
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'scale-in': 'scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both'
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        scaleIn: { '0%': { transform: 'scale(0.95)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* Asosiy CSS */
        body { background-color: #000; color: #fff; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        
        /* Glassmorphism */
        .glass { background: rgba(18, 18, 18, 0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border-top: 1px solid rgba(255,255,255,0.08); }
        .glass-card { background: rgba(30, 30, 30, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 8px 32px rgba(0,0,0,0.4); }

        /* 3D Flip Card Effect */
        .perspective-container { perspective: 1000px; }
        .flip-card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1); transform-style: preserve-3d; }
        .flip-card-front, .flip-card-back { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; border-radius: 1.5rem; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 2rem; }
        .flip-card-back { transform: rotateY(180deg); background: #1C1C1E; }
        .flip-card-front { background: #1C1C1E; }
        .flipped { transform: rotateY(180deg); }

        /* Cloze Style */
        .cloze-hidden { background: #2997FF; color: transparent; border-radius: 4px; padding: 0 4px; cursor: pointer; user-select: none; }
        .cloze-revealed { background: rgba(41, 151, 255, 0.2); color: #2997FF; border-radius: 4px; padding: 0 4px; font-weight: bold; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Heatmap Grid */
        .heatmap-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 3px; }
        .heatmap-cell { width: 100%; padding-top: 100%; border-radius: 2px; background: #222; }
    </style>
</head>
<body class="flex flex-col h-[100dvh] w-full max-w-md mx-auto bg-black border-x border-neutral-900 relative">

    <!-- HEADER -->
    <header class="h-16 flex items-center justify-between px-5 z-20 bg-black/50 backdrop-blur-md sticky top-0">
        <div class="flex items-center gap-2">
            <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-600 to-purple-600 flex items-center justify-center text-xs font-bold shadow-lg shadow-blue-900/40">AI</div>
            <h1 class="text-lg font-bold tracking-tight">Ultra<span class="text-brand-blue">Anki</span></h1>
        </div>
        <div class="flex gap-4 text-sm font-medium">
            <div class="flex items-center gap-1 text-brand-warning">
                <i class="fa-solid fa-fire"></i> <span id="header-streak">0</span>
            </div>
            <div class="flex items-center gap-1 text-brand-blue">
                <i class="fa-solid fa-layer-group"></i> <span id="header-cards">0</span>
            </div>
        </div>
    </header>

    <!-- ASOSIY VIEWPORT (Router render qiladigan joy) -->
    <main id="app-viewport" class="flex-1 overflow-y-auto overflow-x-hidden p-4 relative scroll-smooth pb-24">
        <!-- JS orqali kontent to'ldiriladi -->
    </main>

    <!-- NAVBAR -->
    <nav class="h-20 glass fixed bottom-0 w-full max-w-md z-30 flex justify-around items-center pb-2">
        <button onclick="Router.navigate('decks')" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16" id="nav-decks">
            <i class="fa-solid fa-house text-xl mb-0.5 transition group-active:scale-90"></i>
            <span class="text-[10px] font-medium opacity-70">Uy</span>
        </button>
        
        <button onclick="Router.navigate('add')" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16 -mt-6" id="nav-add">
            <div class="w-12 h-12 bg-brand-blue rounded-full flex items-center justify-center text-white text-xl shadow-lg shadow-blue-500/30 transition group-active:scale-90">
                <i class="fa-solid fa-plus"></i>
            </div>
        </button>
        
        <button onclick="Router.navigate('profile')" class="nav-btn group flex flex-col items-center gap-1 p-2 w-16" id="nav-profile">
            <i class="fa-solid fa-chart-pie text-xl mb-0.5 transition group-active:scale-90"></i>
            <span class="text-[10px] font-medium opacity-70">Profil</span>
        </button>
    </nav>

    <!-- FOOTER (Mandatory) -->
    <div class="fixed bottom-24 left-0 w-full text-center pointer-events-none z-0 opacity-0 animate-slide-up" style="animation-delay: 1s; animation-fill-mode: forwards;">
        <p class="text-[10px] text-neutral-700 font-mono">© Muhammad Daler tomonidan yasalgan</p>
    </div>

    <!-- JAVASCRIPT ENGINE -->
    <script>
        /**
         * ULTRA SMART ANKI ENGINE (v3.0)
         * Tizim: MVC Pattern + LocalStorage + SM-2 Algorithm
         */

        // --- 1. MA'LUMOTLAR BAZASI VA MODEL ---
        const DB = {
            KEY: 'ultra_anki_v3_data',
            state: {
                decks: [],
                cards: [],
                user: { xp: 0, streak: 0, lastStudyDate: null, heatmap: {} },
                settings: { dailyGoal: 20 }
            },

            init() {
                const saved = localStorage.getItem(this.KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        // Eski versiya ma'lumotlarini migratsiya qilish (xavfsizlik uchun)
                        this.state = { ...this.state, ...parsed };
                    } catch (e) {
                        console.error("DB Error:", e);
                        this.seed(); // Agar buzilgan bo'lsa qayta yaratish
                    }
                } else {
                    this.seed();
                }
                this.updateStreak();
            },

            save() {
                localStorage.setItem(this.KEY, JSON.stringify(this.state));
                UI.updateHeader();
            },

            seed() {
                // Boshlang'ich demo ma'lumotlar
                const d1 = this.uuid();
                this.state.decks = [
                    { id: d1, name: "Ingliz Tili (A1)", color: "from-blue-600 to-cyan-500", icon: "fa-earth-americas" },
                    { id: this.uuid(), name: "Dasturlash", color: "from-purple-600 to-pink-600", icon: "fa-code" }
                ];
                
                this.state.cards = [
                    this.createCard(d1, "Apple", "Olma", "basic"),
                    this.createCard(d1, "Hello", "Salom", "basic"),
                    this.createCard(d1, "O'zbekiston poytaxti {{c1::Toshkent}} shahridir.", "", "cloze")
                ];
                this.save();
            },

            uuid() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            },

            createCard(deckId, front, back, type) {
                return {
                    id: this.uuid(),
                    deckId,
                    front,
                    back,
                    type, // 'basic' or 'cloze'
                    step: 0, // 0=new, 1=learning, 2=review
                    interval: 0,
                    ease: 2.5,
                    dueDate: Date.now(), // Hozir o'qish mumkin
                    createdAt: Date.now()
                };
            },

            updateStreak() {
                const today = new Date().toDateString();
                if (this.state.user.lastStudyDate !== today) {
                    // Logic: Agar kecha o'qimagan bo'lsa streak 0 bo'lishi mumkin
                    // Bu yerda oddiy logika: oxirgi o'qish sanasi bugun bo'lmasa, yangilaymiz
                }
            },

            logActivity() {
                const todayStr = new Date().toISOString().split('T')[0];
                const todayFull = new Date().toDateString();

                if (this.state.user.lastStudyDate !== todayFull) {
                    this.state.user.streak++;
                    this.state.user.lastStudyDate = todayFull;
                }
                
                if (!this.state.user.heatmap[todayStr]) this.state.user.heatmap[todayStr] = 0;
                this.state.user.heatmap[todayStr]++;
                this.state.user.xp += 10;
                this.save();
            }
        };

        // --- 2. INTELLIGENT ALGORITHM (SM-2 Modified) ---
        const Algo = {
            // Rating: 0 (Again), 1 (Hard), 2 (Good), 3 (Easy)
            process(card, rating) {
                const now = Date.now();
                const oneDay = 24 * 60 * 60 * 1000;
                const oneMin = 60 * 1000;

                let nextInterval = 0; // ms

                if (rating === 0) { // Again (Qayta)
                    card.step = 0;
                    card.interval = 0;
                    card.ease = Math.max(1.3, card.ease - 0.2);
                    nextInterval = 1 * oneMin; // 1 minutdan keyin
                } else {
                    // Muvaffaqiyatli
                    if (card.step === 0) {
                        card.step = 1;
                        card.interval = 1; // 1 kun
                        nextInterval = 10 * oneMin; // 10 minut
                    } else if (card.step === 1) {
                        card.step = 2;
                        card.interval = 1; // 1 kun
                        nextInterval = 1 * oneDay;
                    } else {
                        // Review Mode (SM-2 math)
                        if (rating === 1) card.ease -= 0.15; // Hard
                        if (rating === 3) card.ease += 0.15; // Easy

                        card.interval = Math.ceil(card.interval * card.ease);
                        
                        // Hard bonus multiplier kamroq
                        if (rating === 1) card.interval = Math.max(1, Math.floor(card.interval * 0.5)); 
                        
                        nextInterval = card.interval * oneDay;
                    }
                }

                card.dueDate = now + nextInterval;
                return card;
            },

            getDueCards(deckId) {
                const now = Date.now();
                return DB.state.cards
                    .filter(c => c.deckId === deckId && c.dueDate <= now)
                    .sort((a, b) => a.dueDate - b.dueDate); // Eng eskisi birinchi
            }
        };

        // --- 3. UI RENDERER & ROUTER ---
        const Router = {
            current: 'decks',
            
            navigate(route, params = null) {
                this.current = route;
                
                // Navbar Active State
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('text-brand-blue');
                    btn.classList.add('text-neutral-500');
                });
                
                const navId = route === 'study' ? 'nav-decks' : `nav-${route}`;
                const activeBtn = document.getElementById(navId);
                if(activeBtn) {
                    activeBtn.classList.add('text-brand-blue');
                    activeBtn.classList.remove('text-neutral-500');
                }

                const viewport = document.getElementById('app-viewport');
                viewport.innerHTML = ''; // Tozalash

                switch(route) {
                    case 'decks': this.renderDecks(viewport); break;
                    case 'add': this.renderAdd(viewport); break;
                    case 'profile': this.renderProfile(viewport); break;
                    case 'study': this.renderStudy(viewport, params); break;
                }
            },

            renderDecks(container) {
                const decks = DB.state.decks;
                const totalDue = DB.state.cards.filter(c => c.dueDate <= Date.now()).length;

                let html = `
                    <div class="space-y-6 animate-slide-up">
                        <!-- Hero Card -->
                        <div class="p-6 rounded-3xl bg-gradient-to-br from-neutral-800 to-neutral-900 border border-neutral-800 relative overflow-hidden">
                            <div class="absolute top-0 right-0 w-32 h-32 bg-brand-blue blur-[80px] opacity-20"></div>
                            <h2 class="text-neutral-400 text-xs font-bold uppercase tracking-widest mb-1">Bugungi Reja</h2>
                            <div class="flex items-end gap-2">
                                <span class="text-4xl font-extrabold text-white">${totalDue}</span>
                                <span class="text-sm text-neutral-400 mb-1.5 font-medium">ta karta takrorlash kerak</span>
                            </div>
                            <div class="mt-4 h-1.5 w-full bg-neutral-800 rounded-full overflow-hidden">
                                <div class="h-full bg-brand-blue rounded-full" style="width: ${Math.min(100, (DB.state.user.xp / 1000) * 100)}%"></div>
                            </div>
                        </div>

                        <!-- Decks List -->
                        <div>
                            <h3 class="text-lg font-bold mb-3 px-1">To'plamlar</h3>
                            <div class="grid gap-3">
                `;

                if (decks.length === 0) {
                    html += `<div class="text-center py-10 text-neutral-500">To'plamlar yo'q. Yangi qo'shing!</div>`;
                }

                decks.forEach(deck => {
                    const dueCount = Algo.getDueCards(deck.id).length;
                    const totalCount = DB.state.cards.filter(c => c.deckId === deck.id).length;
                    
                    html += `
                        <div onclick="Router.navigate('study', '${deck.id}')" class="group relative bg-neutral-900 hover:bg-neutral-800 border border-neutral-800 p-4 rounded-2xl flex items-center justify-between transition active:scale-[0.98]">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${deck.color} flex items-center justify-center text-white text-xl shadow-lg">
                                    <i class="fa-solid ${deck.icon}"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-base group-hover:text-brand-blue transition-colors">${deck.name}</h4>
                                    <p class="text-xs text-neutral-500 font-mono mt-0.5">${totalCount} karta • <span class="${dueCount > 0 ? 'text-brand-success' : ''}">${dueCount} due</span></p>
                                </div>
                            </div>
                            <div class="w-8 h-8 rounded-full bg-black flex items-center justify-center text-neutral-600">
                                <i class="fa-solid fa-chevron-right text-xs"></i>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div></div>`;
                container.innerHTML = html;
            },

            renderStudy(container, deckId) {
                const deck = DB.state.decks.find(d => d.id === deckId);
                const queue = Algo.getDueCards(deckId);
                
                if (queue.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-[70vh] text-center animate-scale-in">
                            <div class="w-24 h-24 rounded-full bg-neutral-900 flex items-center justify-center text-4xl text-brand-success mb-6">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <h2 class="text-2xl font-bold mb-2">Barchasi tamom!</h2>
                            <p class="text-neutral-400 mb-8">Bu to'plam bo'yicha bugungi darslar tugadi.</p>
                            <button onclick="Router.navigate('decks')" class="px-8 py-3 bg-white text-black font-bold rounded-full active:scale-95 transition">Bosh menyu</button>
                        </div>
                    `;
                    return;
                }

                const card = queue[0]; // Take first card
                
                // Cloze Logic Processing
                let frontHTML = card.front;
                let backHTML = card.back;
                
                if (card.type === 'cloze') {
                    // Regex: {{c1::Answer}} -> [ ... ]
                    frontHTML = card.front.replace(/{{c1::(.*?)}}/g, '<span class="cloze-hidden">[ ... ]</span>');
                    backHTML = card.front.replace(/{{c1::(.*?)}}/g, '<span class="cloze-revealed">$1</span>');
                }

                container.innerHTML = `
                    <div class="flex flex-col h-full animate-scale-in">
                        <!-- Top Bar -->
                        <div class="flex justify-between items-center mb-4 px-2">
                            <button onclick="Router.navigate('decks')" class="text-neutral-400 hover:text-white"><i class="fa-solid fa-xmark text-xl"></i></button>
                            <span class="text-xs font-mono text-brand-blue font-bold">${queue.length} ta qoldi</span>
                            <button onclick="StudyController.deleteCard('${card.id}')" class="text-neutral-600 hover:text-brand-danger"><i class="fa-solid fa-trash"></i></button>
                        </div>

                        <!-- Card Container -->
                        <div class="flex-1 perspective-container relative mb-6">
                            <div id="active-card" class="flip-card-inner shadow-2xl" onclick="StudyController.flip()">
                                <!-- FRONT -->
                                <div class="flip-card-front border border-neutral-800">
                                    <div class="text-xs font-bold text-neutral-500 uppercase mb-4 tracking-widest">${deck.name}</div>
                                    <div class="text-2xl font-medium leading-relaxed">${frontHTML}</div>
                                    <div class="absolute bottom-6 text-xs text-neutral-600 animate-pulse">Javobni ko'rish uchun bosing</div>
                                </div>
                                <!-- BACK -->
                                <div class="flip-card-back border border-neutral-800">
                                    <div class="text-base text-neutral-500 line-through mb-6 opacity-50">${card.type === 'basic' ? card.front : ''}</div>
                                    <div class="text-2xl font-bold text-white leading-relaxed">${backHTML}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Controls -->
                        <div id="controls-area" class="h-16">
                            <!-- Show Answer Button -->
                            <button id="btn-show" onclick="StudyController.flip()" class="w-full h-14 bg-brand-blue hover:bg-blue-600 text-white font-bold rounded-xl shadow-lg shadow-blue-900/20 active:scale-[0.98] transition">
                                Javobni ko'rsatish
                            </button>

                            <!-- Grading Buttons (Initially Hidden) -->
                            <div id="btn-grading" class="hidden grid-cols-4 gap-2 h-14">
                                <button onclick="StudyController.rate('${card.id}', 0, '${deckId}')" class="bg-neutral-900 border border-brand-danger/30 text-brand-danger rounded-xl font-bold text-sm flex flex-col items-center justify-center hover:bg-brand-danger/10 active:scale-95">
                                    <span>Qayta</span><span class="text-[10px] opacity-60">1m</span>
                                </button>
                                <button onclick="StudyController.rate('${card.id}', 1, '${deckId}')" class="bg-neutral-900 border border-brand-warning/30 text-brand-warning rounded-xl font-bold text-sm flex flex-col items-center justify-center hover:bg-brand-warning/10 active:scale-95">
                                    <span>Qiyin</span><span class="text-[10px] opacity-60">10m</span>
                                </button>
                                <button onclick="StudyController.rate('${card.id}', 2, '${deckId}')" class="bg-neutral-900 border border-brand-success/30 text-brand-success rounded-xl font-bold text-sm flex flex-col items-center justify-center hover:bg-brand-success/10 active:scale-95">
                                    <span>Yaxshi</span><span class="text-[10px] opacity-60">1d</span>
                                </button>
                                <button onclick="StudyController.rate('${card.id}', 3, '${deckId}')" class="bg-neutral-900 border border-brand-blue/30 text-brand-blue rounded-xl font-bold text-sm flex flex-col items-center justify-center hover:bg-brand-blue/10 active:scale-95">
                                    <span>Oson</span><span class="text-[10px] opacity-60">4d</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderAdd(container) {
                const decks = DB.state.decks;
                let deckOptions = decks.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

                container.innerHTML = `
                    <div class="animate-slide-up space-y-6">
                        <h2 class="text-2xl font-bold">Yangi qo'shish</h2>
                        
                        <!-- Tabs -->
                        <div class="flex p-1 bg-neutral-900 rounded-xl border border-neutral-800">
                            <button id="tab-card" onclick="UI.toggleAddTab('card')" class="flex-1 py-2 text-sm font-bold rounded-lg bg-neutral-800 text-white shadow transition">Karta</button>
                            <button id="tab-deck" onclick="UI.toggleAddTab('deck')" class="flex-1 py-2 text-sm font-bold rounded-lg text-neutral-500 hover:text-white transition">To'plam</button>
                        </div>

                        <!-- ADD CARD FORM -->
                        <div id="form-card" class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-neutral-500 mb-2 uppercase">To'plam</label>
                                <select id="inp-deck-id" class="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-4 text-white outline-none focus:border-brand-blue transition appearance-none">
                                    ${deckOptions}
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-neutral-500 mb-2 uppercase">Turi</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <button onclick="UI.setCardType('basic')" id="type-basic" class="py-3 rounded-xl border border-brand-blue bg-brand-blue/10 text-brand-blue font-bold text-sm">Savol-Javob</button>
                                    <button onclick="UI.setCardType('cloze')" id="type-cloze" class="py-3 rounded-xl border border-neutral-800 bg-neutral-900 text-neutral-500 font-bold text-sm">Cloze (Bo'shliq)</button>
                                </div>
                            </div>

                            <div>
                                <label class="block text-xs font-bold text-neutral-500 mb-2 uppercase">Front (Savol)</label>
                                <textarea id="inp-front" rows="3" class="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-4 text-white text-lg outline-none focus:border-brand-blue transition resize-none placeholder-neutral-700" placeholder="Savolni kiriting..."></textarea>
                                <p id="cloze-hint" class="hidden text-[10px] text-brand-blue mt-1">Masalan: O'zbekiston poytaxti {{c1::Toshkent}}.</p>
                            </div>

                            <div id="back-container">
                                <label class="block text-xs font-bold text-neutral-500 mb-2 uppercase">Back (Javob)</label>
                                <textarea id="inp-back" rows="3" class="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-4 text-white text-lg outline-none focus:border-brand-blue transition resize-none placeholder-neutral-700" placeholder="Javobni kiriting..."></textarea>
                            </div>

                            <button onclick="Action.addCard()" class="w-full py-4 bg-brand-blue text-white font-bold rounded-xl text-lg shadow-lg shadow-blue-900/30 active:scale-[0.98] transition">Saqlash</button>
                        </div>

                        <!-- ADD DECK FORM -->
                        <div id="form-deck" class="space-y-4 hidden">
                            <div>
                                <label class="block text-xs font-bold text-neutral-500 mb-2 uppercase">Nomi</label>
                                <input type="text" id="inp-deck-name" class="w-full bg-neutral-900 border border-neutral-800 rounded-xl p-4 text-white outline-none focus:border-brand-blue transition" placeholder="Fan nomi...">
                            </div>
                            <button onclick="Action.addDeck()" class="w-full py-4 bg-white text-black font-bold rounded-xl text-lg active:scale-[0.98] transition">Yaratish</button>
                        </div>
                    </div>
                `;
            },

            renderProfile(container) {
                const user = DB.state.user;
                // Fake heatmap generation
                let gridHTML = '';
                for(let i=0; i<60; i++) {
                    const opacity = Math.random() > 0.7 ? Math.random() : 0.1;
                    const color = Math.random() > 0.7 ? `rgba(48, 209, 88, ${opacity})` : '#222';
                    gridHTML += `<div class="heatmap-cell" style="background-color: ${color}"></div>`;
                }

                container.innerHTML = `
                    <div class="animate-slide-up">
                        <div class="flex items-center gap-4 mb-8">
                            <div class="w-20 h-20 rounded-full bg-neutral-800 flex items-center justify-center border-2 border-brand-blue overflow-hidden">
                                <i class="fa-solid fa-robot text-3xl text-neutral-400"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-bold text-white">Foydalanuvchi</h2>
                                <p class="text-brand-blue font-mono font-bold">${user.xp} XP</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="glass-card p-4 rounded-2xl">
                                <div class="text-brand-warning text-xl mb-1"><i class="fa-solid fa-fire"></i></div>
                                <div class="text-2xl font-bold">${user.streak}</div>
                                <div class="text-xs text-neutral-500 uppercase font-bold">Kunlik Streak</div>
                            </div>
                            <div class="glass-card p-4 rounded-2xl">
                                <div class="text-brand-blue text-xl mb-1"><i class="fa-solid fa-layer-group"></i></div>
                                <div class="text-2xl font-bold">${DB.state.cards.length}</div>
                                <div class="text-xs text-neutral-500 uppercase font-bold">Jami Kartalar</div>
                            </div>
                        </div>

                        <div class="bg-neutral-900 p-4 rounded-2xl border border-neutral-800">
                            <h3 class="text-xs font-bold text-neutral-500 uppercase mb-3">Faollik (So'nggi 60 kun)</h3>
                            <div class="heatmap-grid mb-2">
                                ${gridHTML}
                            </div>
                        </div>
                        
                        <button onclick="Action.clearData()" class="mt-8 w-full py-3 border border-brand-danger/50 text-brand-danger rounded-xl text-sm font-bold hover:bg-brand-danger/10">Barcha ma'lumotlarni o'chirish</button>
                    </div>
                `;
            }
        };

        // --- 4. CONTROLLERS ---
        const UI = {
            currentCardType: 'basic',

            updateHeader() {
                document.getElementById('header-streak').innerText = DB.state.user.streak;
                document.getElementById('header-cards').innerText = DB.state.cards.length;
            },

            toggleAddTab(tab) {
                const btnCard = document.getElementById('tab-card');
                const btnDeck = document.getElementById('tab-deck');
                const formCard = document.getElementById('form-card');
                const formDeck = document.getElementById('form-deck');

                if (tab === 'card') {
                    btnCard.className = 'flex-1 py-2 text-sm font-bold rounded-lg bg-neutral-800 text-white shadow transition';
                    btnDeck.className = 'flex-1 py-2 text-sm font-bold rounded-lg text-neutral-500 hover:text-white transition';
                    formCard.classList.remove('hidden');
                    formDeck.classList.add('hidden');
                } else {
                    btnDeck.className = 'flex-1 py-2 text-sm font-bold rounded-lg bg-neutral-800 text-white shadow transition';
                    btnCard.className = 'flex-1 py-2 text-sm font-bold rounded-lg text-neutral-500 hover:text-white transition';
                    formDeck.classList.remove('hidden');
                    formCard.classList.add('hidden');
                }
            },

            setCardType(type) {
                this.currentCardType = type;
                const btnBasic = document.getElementById('type-basic');
                const btnCloze = document.getElementById('type-cloze');
                const backContainer = document.getElementById('back-container');
                const hint = document.getElementById('cloze-hint');

                if (type === 'basic') {
                    btnBasic.classList.replace('border-neutral-800', 'border-brand-blue');
                    btnBasic.classList.replace('bg-neutral-900', 'bg-brand-blue/10');
                    btnBasic.classList.replace('text-neutral-500', 'text-brand-blue');

                    btnCloze.classList.replace('border-brand-blue', 'border-neutral-800');
                    btnCloze.classList.replace('bg-brand-blue/10', 'bg-neutral-900');
                    btnCloze.classList.replace('text-brand-blue', 'text-neutral-500');

                    backContainer.classList.remove('hidden');
                    hint.classList.add('hidden');
                } else {
                    btnCloze.classList.replace('border-neutral-800', 'border-brand-blue');
                    btnCloze.classList.replace('bg-neutral-900', 'bg-brand-blue/10');
                    btnCloze.classList.replace('text-neutral-500', 'text-brand-blue');

                    btnBasic.classList.replace('border-brand-blue', 'border-neutral-800');
                    btnBasic.classList.replace('bg-brand-blue/10', 'bg-neutral-900');
                    btnBasic.classList.replace('text-brand-blue', 'text-neutral-500');

                    backContainer.classList.add('hidden');
                    hint.classList.remove('hidden');
                }
            }
        };

        const Action = {
            addDeck() {
                const name = document.getElementById('inp-deck-name').value;
                if (!name) return alert("Nom yozilmadi!");
                
                const colors = ['from-purple-600 to-indigo-600', 'from-green-500 to-emerald-700', 'from-orange-500 to-red-600', 'from-pink-500 to-rose-600'];
                const icons = ['fa-atom', 'fa-book', 'fa-code', 'fa-globe'];

                DB.state.decks.push({
                    id: DB.uuid(),
                    name: name,
                    color: colors[Math.floor(Math.random()*colors.length)],
                    icon: icons[Math.floor(Math.random()*icons.length)]
                });
                DB.save();
                Router.navigate('decks');
            },

            addCard() {
                const deckId = document.getElementById('inp-deck-id').value;
                const front = document.getElementById('inp-front').value;
                const back = document.getElementById('inp-back').value;

                if (!front) return alert("Savol yozilmadi!");
                if (UI.currentCardType === 'basic' && !back) return alert("Javob yozilmadi!");
                if (UI.currentCardType === 'cloze' && !front.includes('{{c1::')) return alert("Cloze format xato! {{c1::javob}} ko'rinishida yozing.");

                DB.state.cards.push(DB.createCard(deckId, front, UI.currentCardType === 'cloze' ? '' : back, UI.currentCardType));
                DB.save();
                
                document.getElementById('inp-front').value = '';
                document.getElementById('inp-back').value = '';
                alert("Muvaffaqiyatli qo'shildi!");
            },

            clearData() {
                if(confirm("Hamma narsa o'chib ketadi! Aniqmi?")) {
                    localStorage.removeItem(DB.KEY);
                    location.reload();
                }
            }
        };

        const StudyController = {
            isFlipped: false,

            flip() {
                const card = document.getElementById('active-card');
                const btnShow = document.getElementById('btn-show');
                const btnGrading = document.getElementById('btn-grading');

                if (!this.isFlipped) {
                    card.classList.add('flipped');
                    btnShow.classList.add('hidden');
                    btnGrading.classList.remove('hidden');
                    btnGrading.classList.add('grid');
                    this.isFlipped = true;
                }
            },

            rate(cardId, rating, deckId) {
                const cardIndex = DB.state.cards.findIndex(c => c.id === cardId);
                if (cardIndex === -1) return;

                // Smart Algorithm Process
                DB.state.cards[cardIndex] = Algo.process(DB.state.cards[cardIndex], rating);
                DB.logActivity();
                DB.save();

                this.isFlipped = false;
                Router.navigate('study', deckId); // Refresh view for next card
            },

            deleteCard(cardId) {
                if(!confirm("Bu kartani o'chirmoqchimisiz?")) return;
                DB.state.cards = DB.state.cards.filter(c => c.id !== cardId);
                DB.save();
                // Refresh logic needed, simple way: go back to decks or re-render
                Router.navigate('decks'); 
            }
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            DB.init();
            UI.updateHeader();
            Router.navigate('decks');
        });

    </script>
</body>
</html>


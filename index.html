<!DOCTYPE html>
<html lang="uz" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quantum Anki - Ultra Smart</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['SF Pro Display', '-apple-system', 'Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                    colors: {
                        q: { 
                            bg: '#000000', 
                            surface: '#121212', 
                            surfaceLight: '#1E1E1E',
                            border: '#333333',
                            primary: '#2563EB', // Blue
                            accent: '#7C3AED', // Violet
                            success: '#10B981',
                            warning: '#F59E0B',
                            error: '#EF4444',
                            text: '#FFFFFF',
                            textMuted: '#9CA3AF'
                        }
                    },
                    boxShadow: {
                        'neon': '0 0 20px rgba(37, 99, 235, 0.3)',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)'
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pop': 'pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: 0 }, '100%': { opacity: 1 } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: 0 }, '100%': { transform: 'translateY(0)', opacity: 1 } },
                        pop: { '0%': { transform: 'scale(0.9)' }, '100%': { transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* --- GLOBAL STYLES --- */
        body { background-color: #000; color: #fff; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        
        /* Glassmorphism */
        .glass-panel {
            background: rgba(30, 30, 30, 0.70);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* 3D Card Engine */
        .scene { perspective: 1200px; }
        .card-3d {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1);
        }
        .card-face {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border-radius: 1.5rem; display: flex; flex-direction: column;
            justify-content: center; align-items: center; padding: 2rem;
            background: #18181b; border: 1px solid #27272a;
        }
        .card-back { transform: rotateY(180deg); background: #18181b; }
        .is-flipped { transform: rotateY(180deg); }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tap-effect:active { transform: scale(0.96); transition: transform 0.1s; }
        
        /* Cloze Styles */
        .cloze-hidden {
            background: linear-gradient(45deg, #2563EB, #7C3AED);
            color: transparent; border-radius: 4px; padding: 2px 8px;
            font-weight: bold; cursor: help; user-select: none;
        }
        .cloze-revealed {
            color: #60A5FA; font-weight: bold; border-bottom: 2px solid #2563EB;
        }

        /* Heatmap Grid */
        .heatmap-grid { display: grid; grid-template-columns: repeat(14, 1fr); gap: 4px; }
        .heatmap-cell { width: 100%; padding-top: 100%; border-radius: 3px; background: #27272a; }
        .heat-1 { background: #064e3b; } /* Low */
        .heat-2 { background: #10b981; } /* Med */
        .heat-3 { background: #34d399; } /* High */
        .heat-4 { background: #6ee7b7; box-shadow: 0 0 8px #6ee7b7; } /* Ultra */

    </style>
</head>
<body class="h-[100dvh] w-full flex flex-col items-center justify-center bg-black">

    <!-- MOBILE CONTAINER -->
    <div id="root" class="w-full h-full max-w-md bg-black relative flex flex-col overflow-hidden shadow-2xl border-x border-q-border">
        
        <!-- HEADER (Dynamic) -->
        <header id="app-header" class="h-16 px-5 flex items-center justify-between z-20 absolute top-0 w-full glass-panel border-b-0 rounded-b-2xl transition-all">
            <!-- JS Renders Content Here -->
        </header>

        <!-- MAIN VIEWPORT -->
        <main id="viewport" class="flex-1 overflow-y-auto overflow-x-hidden pt-20 pb-24 px-4 scroll-smooth no-scrollbar">
            <!-- Views Injected Here -->
        </main>

        <!-- BOTTOM NAV -->
        <nav class="h-20 w-full max-w-md fixed bottom-0 z-30 glass-panel border-t border-white/5 flex justify-around items-center pb-2">
            <button onclick="App.router('home')" id="nav-home" class="nav-btn tap-effect flex flex-col items-center gap-1 w-16 text-q-primary">
                <i class="fa-solid fa-layer-group text-xl"></i>
                <span class="text-[10px] font-bold tracking-wide">Darslar</span>
            </button>
            <button onclick="App.router('create')" id="nav-create" class="nav-btn tap-effect flex flex-col items-center justify-center w-14 h-14 -mt-8 bg-gradient-to-tr from-blue-600 to-violet-600 rounded-full shadow-neon text-white border-4 border-black">
                <i class="fa-solid fa-plus text-xl"></i>
            </button>
            <button onclick="App.router('profile')" id="nav-profile" class="nav-btn tap-effect flex flex-col items-center gap-1 w-16 text-q-textMuted">
                <i class="fa-solid fa-chart-simple text-xl"></i>
                <span class="text-[10px] font-bold tracking-wide">Statistika</span>
            </button>
        </nav>
        
        <!-- NOTIFICATIONS (Toast) -->
        <div id="toast-container" class="absolute top-20 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none w-full px-4"></div>

    </div>

    <!-- ---------------------- ENGINE ---------------------- -->
    <script>
        /**
         * QUANTUM ENGINE v4.0
         * "Xotira muammolari hal qilindi. SM-2 Algoritmi mukammallashtirildi."
         */

        // 1. DATA STORE (Persistent Layer)
        const Store = {
            KEY: 'quantum_anki_data',
            data: {
                decks: [],
                cards: [],
                user: { xp: 0, level: 1, streak: 0, lastStudy: null, logs: [] },
                settings: { cardsPerDay: 20 }
            },

            init() {
                const raw = localStorage.getItem(this.KEY);
                if (raw) {
                    try {
                        const parsed = JSON.parse(raw);
                        this.data = { ...this.data, ...parsed }; // Merge safe
                    } catch (e) {
                        console.error("Data Corruption Detected. Resetting.");
                        this.seed();
                    }
                } else {
                    this.seed();
                }
                this.calcStreak();
            },

            save() {
                localStorage.setItem(this.KEY, JSON.stringify(this.data));
                UI.updateHeader();
            },

            seed() {
                // Default data for new users
                const d1 = this.id();
                this.data.decks = [
                    { id: d1, name: "Ingliz Tili (Top 500)", icon: "fa-earth-americas", color: "from-blue-600 to-cyan-500" },
                    { id: this.id(), name: "Dasturlash (JS)", icon: "fa-code", color: "from-violet-600 to-fuchsia-600" }
                ];
                this.data.cards = [
                    this.makeCard(d1, "Hello", "Salom", "basic"),
                    this.makeCard(d1, "Apple", "Olma", "basic"),
                    this.makeCard(d1, "JavaScriptda o'zgaruvchi {{c1::let}} yoki {{c1::const}} orqali e'lon qilinadi.", "", "cloze")
                ];
                this.save();
            },

            id() { return Math.random().toString(36).substr(2, 9); },

            makeCard(deckId, front, back, type) {
                return {
                    id: this.id(), deckId, front, back, type,
                    // SRS Data
                    state: 'new', // new, learning, review, relearning
                    interval: 0, // days
                    ease: 2.5, // difficulty multiplier
                    dueDate: Date.now(), // timestamp
                    step: 0 // for learning steps (1m, 10m)
                };
            },

            calcStreak() {
                const today = new Date().toDateString();
                const last = this.data.user.lastStudy;
                
                if (last === today) return; // Already studied today

                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (last === yesterday.toDateString()) {
                    // Streaked kept
                } else if (last && last !== today) {
                    // Streak broken (unless it's the very first day)
                    // Simple logic: if difference > 1 day, reset
                    const d1 = new Date(last);
                    const d2 = new Date();
                    const diffTime = Math.abs(d2 - d1);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    if (diffDays > 1) this.data.user.streak = 0;
                }
            },

            logReview(cardId, rating) {
                const today = new Date().toDateString();
                if (this.data.user.lastStudy !== today) {
                    this.data.user.streak++;
                    this.data.user.lastStudy = today;
                }
                
                // Add to detailed logs (timestamp for heatmap)
                this.data.user.logs.push({ date: Date.now(), rating });
                
                // Add XP
                const xpGain = rating === 1 ? 2 : (rating * 5);
                this.data.user.xp += xpGain;
                this.data.user.level = Math.floor(this.data.user.xp / 500) + 1;
                
                this.save();
            }
        };

        // 2. BRAIN (SM-2 ENHANCED ALGORITHM)
        const Brain = {
            // Ratings: 1 (Again), 2 (Hard), 3 (Good), 4 (Easy)
            process(card, rating) {
                const now = Date.now();
                const MINUTE = 60 * 1000;
                const DAY = 24 * 60 * 60 * 1000;

                let nextDue = 0;

                if (rating === 1) { // AGAIN (Forgot)
                    card.state = 'learning';
                    card.step = 0;
                    card.interval = 0;
                    card.ease = Math.max(1.3, card.ease - 0.2);
                    nextDue = 1 * MINUTE; // Review in 1 min
                } 
                else if (card.state === 'learning' || card.state === 'new') {
                    if (rating === 2) { // HARD
                        nextDue = 5 * MINUTE; // Repeat in 5 mins
                    } else if (rating === 3) { // GOOD
                        card.step++;
                        if (card.step >= 2) {
                            card.state = 'review';
                            card.interval = 1; // Graduate to 1 day
                            nextDue = 1 * DAY;
                        } else {
                            nextDue = 10 * MINUTE; // Review in 10 mins
                        }
                    } else if (rating === 4) { // EASY
                        card.state = 'review';
                        card.interval = 3; // Graduate to 3 days immediately
                        card.ease += 0.15;
                        nextDue = 3 * DAY;
                    }
                } 
                else { // REVIEW MODE
                    if (rating === 2) { // HARD
                        card.interval = Math.max(1, card.interval * 1.2);
                        card.ease -= 0.15;
                    } else if (rating === 3) { // GOOD
                        card.interval = Math.ceil(card.interval * card.ease);
                    } else if (rating === 4) { // EASY
                        card.interval = Math.ceil(card.interval * card.ease * 1.3);
                        card.ease += 0.15;
                    }
                    nextDue = card.interval * DAY;
                }

                // Apply updates
                card.dueDate = now + nextDue;
                if (card.ease < 1.3) card.ease = 1.3; // Min limit

                return card;
            },

            getQueue(deckId) {
                const now = Date.now();
                return Store.data.cards
                    .filter(c => c.deckId === deckId && c.dueDate <= now)
                    .sort((a, b) => a.dueDate - b.dueDate); // Prioritize overdue
            }
        };

        // 3. UI RENDERER
        const UI = {
            updateHeader() {
                const header = document.getElementById('app-header');
                const user = Store.data.user;
                // Only update if we are not in study mode (study mode overrides header)
                if (App.currentView !== 'study') {
                    header.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-[2px]">
                                <div class="w-full h-full bg-black rounded-full flex items-center justify-center font-bold text-xs">
                                    LVL ${user.level}
                                </div>
                            </div>
                            <div>
                                <h1 class="text-sm font-bold text-white leading-tight">Mening Profilim</h1>
                                <p class="text-[10px] text-q-textMuted font-mono">${user.xp} XP â€¢ ${user.streak} Kun Streak</p>
                            </div>
                        </div>
                        <div class="w-8 h-8 rounded-full bg-q-surfaceLight flex items-center justify-center text-q-warning shadow-neon">
                            <i class="fa-solid fa-fire text-sm"></i>
                        </div>
                    `;
                }
            },

            toast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                const colors = type === 'success' ? 'bg-q-success text-black' : 'bg-q-surfaceLight text-white border border-q-border';
                el.className = `${colors} px-4 py-3 rounded-xl shadow-2xl mb-2 text-sm font-bold text-center animate-pop`;
                el.innerText = msg;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    setTimeout(() => el.remove(), 300);
                }, 2000);
            }
        };

        // 4. APP CONTROLLER (ROUTER & LOGIC)
        const App = {
            currentView: 'home',
            activeDeck: null,
            studyQueue: [],
            currentCard: null,

            init() {
                Store.init();
                this.router('home');
            },

            router(view, param = null) {
                this.currentView = view;
                const vp = document.getElementById('viewport');
                const navBtns = document.querySelectorAll('.nav-btn');
                
                // Update Nav State
                navBtns.forEach(b => b.classList.replace('text-q-primary', 'text-q-textMuted'));
                const activeNav = document.getElementById(`nav-${view}`);
                if (activeNav) activeNav.classList.replace('text-q-textMuted', 'text-q-primary');

                // Render Views
                if (view === 'home') this.renderHome(vp);
                else if (view === 'create') this.renderCreate(vp);
                else if (view === 'profile') this.renderProfile(vp);
                else if (view === 'study') this.renderStudy(vp, param);
                
                UI.updateHeader();
            },

            renderHome(container) {
                const decks = Store.data.decks;
                const totalDue = Store.data.cards.filter(c => c.dueDate <= Date.now()).length;

                let html = `
                    <div class="animate-slide-up space-y-6">
                        <!-- Hero Section -->
                        <div class="w-full p-6 rounded-3xl bg-gradient-to-br from-blue-900/50 to-violet-900/50 border border-white/10 relative overflow-hidden">
                            <div class="absolute -right-10 -top-10 w-40 h-40 bg-blue-500 blur-[80px] opacity-30"></div>
                            <h2 class="text-xs font-bold text-blue-300 uppercase tracking-widest mb-1">Bugungi Reja</h2>
                            <div class="flex items-end gap-2">
                                <span class="text-5xl font-extrabold text-white tracking-tighter">${totalDue}</span>
                                <span class="text-sm text-gray-400 mb-2">ta karta kutyapti</span>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <div class="h-1 flex-1 bg-white/10 rounded-full overflow-hidden">
                                    <div class="h-full bg-blue-500 w-[${Math.min(100, (Store.data.user.xp % 500) / 5)}%]"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Decks Grid -->
                        <div>
                            <h3 class="text-lg font-bold mb-3 px-1">To'plamlar</h3>
                            <div class="space-y-3">
                `;

                decks.forEach(deck => {
                    const dueCount = Brain.getQueue(deck.id).length;
                    const totalCards = Store.data.cards.filter(c => c.deckId === deck.id).length;
                    
                    html += `
                        <div onclick="App.startStudy('${deck.id}')" class="group tap-effect relative bg-q-surface hover:bg-q-surfaceLight border border-q-border p-4 rounded-2xl flex items-center justify-between transition cursor-pointer">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${deck.color} flex items-center justify-center text-white text-xl shadow-lg">
                                    <i class="fa-solid ${deck.icon}"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-base text-white group-hover:text-blue-400 transition-colors">${deck.name}</h4>
                                    <p class="text-xs text-gray-500 mt-1 font-mono">${totalCards} Cards â€¢ <span class="${dueCount > 0 ? 'text-q-success font-bold' : ''}">${dueCount} Due</span></p>
                                </div>
                            </div>
                            <div class="w-8 h-8 rounded-full bg-black border border-q-border flex items-center justify-center text-gray-500">
                                <i class="fa-solid fa-play text-xs ml-0.5"></i>
                            </div>
                        </div>
                    `;
                });

                html += `</div></div></div>`;
                container.innerHTML = html;
            },

            renderCreate(container) {
                const decks = Store.data.decks;
                const options = decks.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

                container.innerHTML = `
                    <div class="animate-slide-up space-y-5">
                        <h2 class="text-2xl font-bold px-1">Yangi Karta</h2>
                        
                        <div class="p-1 bg-q-surfaceLight rounded-xl flex border border-q-border">
                            <button onclick="App.toggleType('basic')" id="btn-basic" class="flex-1 py-2 rounded-lg text-xs font-bold bg-q-primary text-white shadow transition">Savol-Javob</button>
                            <button onclick="App.toggleType('cloze')" id="btn-cloze" class="flex-1 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition">Cloze (Bo'shliq)</button>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 ml-1">TO'PLAM</label>
                                <select id="inp-deck" class="w-full mt-1 bg-q-surface border border-q-border rounded-xl p-4 text-white outline-none focus:border-q-primary transition appearance-none font-medium">
                                    ${options}
                                </select>
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-gray-500 ml-1">SAVOL (FRONT)</label>
                                <textarea id="inp-front" class="w-full mt-1 bg-q-surface border border-q-border rounded-xl p-4 text-white text-lg outline-none focus:border-q-primary transition min-h-[100px]" placeholder="Savolni kiriting..."></textarea>
                                <p id="hint-cloze" class="hidden text-[10px] text-blue-400 mt-1 ml-1">Format: {{c1::yashirin so'z}}</p>
                            </div>

                            <div id="box-back">
                                <label class="text-xs font-bold text-gray-500 ml-1">JAVOB (BACK)</label>
                                <textarea id="inp-back" class="w-full mt-1 bg-q-surface border border-q-border rounded-xl p-4 text-white text-lg outline-none focus:border-q-primary transition min-h-[100px]" placeholder="Javobni kiriting..."></textarea>
                            </div>

                            <button onclick="App.saveCard()" class="w-full py-4 bg-q-primary hover:bg-blue-600 text-white font-bold rounded-xl shadow-neon tap-effect transition">
                                Qo'shish
                            </button>
                            
                            <div class="pt-4 border-t border-white/5">
                                <h3 class="text-xs font-bold text-gray-500 mb-2">Yangi To'plam Yaratish</h3>
                                <div class="flex gap-2">
                                    <input id="inp-deck-name" type="text" placeholder="To'plam nomi" class="flex-1 bg-q-surface border border-q-border rounded-xl px-4 text-white text-sm outline-none">
                                    <button onclick="App.saveDeck()" class="px-6 py-3 bg-q-surfaceLight border border-q-border text-white font-bold rounded-xl text-xs hover:bg-white/10">Yaratish</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },

            renderProfile(container) {
                const user = Store.data.user;
                // Generate Heatmap Data
                const today = new Date();
                let grid = '';
                // Simple logic: last 98 days
                for(let i=0; i<98; i++) {
                    const d = new Date();
                    d.setDate(today.getDate() - (97 - i));
                    // Check logs for this date
                    const count = user.logs.filter(l => new Date(l.date).toDateString() === d.toDateString()).length;
                    let cls = 'bg-q-surfaceLight';
                    if (count > 0) cls = 'heat-1';
                    if (count > 5) cls = 'heat-2';
                    if (count > 10) cls = 'heat-3';
                    if (count > 20) cls = 'heat-4';
                    
                    grid += `<div class="heatmap-cell ${cls}" title="${d.toDateString()}: ${count}"></div>`;
                }

                container.innerHTML = `
                    <div class="animate-slide-up space-y-6">
                        <div class="text-center pt-4">
                            <div class="inline-block relative">
                                <div class="w-24 h-24 rounded-full bg-q-surfaceLight border-2 border-q-primary flex items-center justify-center text-4xl shadow-neon">
                                    ðŸš€
                                </div>
                                <div class="absolute -bottom-2 -right-2 bg-black px-3 py-1 rounded-full border border-q-border text-xs font-bold">Lvl ${user.level}</div>
                            </div>
                            <h2 class="text-2xl font-bold mt-4">Statistika</h2>
                            <p class="text-gray-400 text-sm">Doimiy rivojlanish sari</p>
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div class="p-4 bg-q-surface rounded-2xl border border-q-border text-center">
                                <i class="fa-solid fa-fire text-q-warning text-2xl mb-2"></i>
                                <div class="text-xl font-bold text-white">${user.streak}</div>
                                <div class="text-[10px] uppercase font-bold text-gray-500">Kunlik Streak</div>
                            </div>
                            <div class="p-4 bg-q-surface rounded-2xl border border-q-border text-center">
                                <i class="fa-solid fa-brain text-q-accent text-2xl mb-2"></i>
                                <div class="text-xl font-bold text-white">${Store.data.cards.length}</div>
                                <div class="text-[10px] uppercase font-bold text-gray-500">Jami Kartalar</div>
                            </div>
                        </div>

                        <div class="p-4 bg-q-surface rounded-2xl border border-q-border">
                            <h3 class="text-xs font-bold text-gray-500 uppercase mb-3 flex justify-between">
                                <span>Faollik Jadvali</span>
                                <span>So'nggi 3 oy</span>
                            </h3>
                            <div class="heatmap-grid w-full">
                                ${grid}
                            </div>
                        </div>

                        <button onclick="App.resetData()" class="w-full py-3 text-q-error text-xs font-bold opacity-50 hover:opacity-100">Barcha ma'lumotlarni o'chirish</button>
                    </div>
                `;
            },

            // --- STUDY LOGIC ---
            
            startStudy(deckId) {
                this.studyQueue = Brain.getQueue(deckId);
                if (this.studyQueue.length === 0) {
                    UI.toast("Bugunga darslar tugagan! ðŸŽ‰", "success");
                    return;
                }
                this.router('study', deckId);
            },

            renderStudy(container, deckId) {
                const deck = Store.data.decks.find(d => d.id === deckId);
                
                // Override Header
                const header = document.getElementById('app-header');
                header.innerHTML = `
                    <button onclick="App.router('home')" class="w-8 h-8 flex items-center justify-center rounded-full bg-q-surfaceLight text-white"><i class="fa-solid fa-xmark"></i></button>
                    <div class="text-sm font-bold text-gray-400"><span id="q-count">${this.studyQueue.length}</span> qoldi</div>
                    <div class="w-8"></div>
                `;

                container.innerHTML = `
                    <div class="h-full flex flex-col relative">
                        <!-- PROGRESS BAR -->
                        <div class="w-full h-1 bg-white/10 rounded-full mb-4 mt-2">
                            <div id="study-progress" class="h-full bg-q-primary rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>

                        <!-- CARD AREA -->
                        <div class="flex-1 scene py-4">
                            <div id="study-card" class="card-3d shadow-2xl" onclick="App.flipCard()">
                                <!-- FRONT -->
                                <div class="card-face card-front">
                                    <span class="absolute top-6 left-6 text-[10px] font-bold text-q-primary bg-blue-900/30 px-2 py-1 rounded uppercase tracking-wider">${deck.name}</span>
                                    <div id="card-front-content" class="text-2xl font-medium text-center leading-relaxed"></div>
                                    <p class="absolute bottom-8 text-xs text-gray-600 font-mono animate-pulse">Tap to flip</p>
                                </div>
                                <!-- BACK -->
                                <div class="card-face card-back">
                                    <div id="card-front-ref" class="text-sm text-gray-500 line-through mb-6 opacity-50"></div>
                                    <div id="card-back-content" class="text-3xl font-bold text-white text-center leading-relaxed text-shadow-sm"></div>
                                </div>
                            </div>
                        </div>

                        <!-- CONTROLS -->
                        <div class="h-24 pb-2 relative">
                            <button id="btn-reveal" onclick="App.flipCard()" class="w-full h-16 bg-q-primary text-white font-bold rounded-2xl shadow-neon text-lg tracking-wide tap-effect">
                                Javobni Ko'rsatish
                            </button>

                            <div id="grid-grading" class="hidden grid-cols-4 gap-2 h-16 animate-slide-up">
                                <button onclick="App.rateCard(1)" class="flex flex-col items-center justify-center bg-q-surfaceLight border border-q-error/30 text-q-error rounded-xl active:scale-95">
                                    <span class="font-bold">Again</span><span class="text-[9px] opacity-70">1m</span>
                                </button>
                                <button onclick="App.rateCard(2)" class="flex flex-col items-center justify-center bg-q-surfaceLight border border-q-warning/30 text-q-warning rounded-xl active:scale-95">
                                    <span class="font-bold">Hard</span><span class="text-[9px] opacity-70">5m</span>
                                </button>
                                <button onclick="App.rateCard(3)" class="flex flex-col items-center justify-center bg-q-surfaceLight border border-q-success/30 text-q-success rounded-xl active:scale-95">
                                    <span class="font-bold">Good</span><span class="text-[9px] opacity-70">10m</span>
                                </button>
                                <button onclick="App.rateCard(4)" class="flex flex-col items-center justify-center bg-q-surfaceLight border border-q-primary/30 text-q-primary rounded-xl active:scale-95">
                                    <span class="font-bold">Easy</span><span class="text-[9px] opacity-70">4d</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;

                this.loadNextCard();
            },

            loadNextCard() {
                if (this.studyQueue.length === 0) {
                    // Session Complete
                    UI.toast("Sessiya yakunlandi!", "success");
                    this.router('home');
                    return;
                }

                this.currentCard = this.studyQueue[0];
                document.getElementById('q-count').innerText = this.studyQueue.length;
                
                // Reset UI
                const cardEl = document.getElementById('study-card');
                cardEl.classList.remove('is-flipped');
                cardEl.style.transform = 'rotateY(0deg)'; // Force reset
                document.getElementById('btn-reveal').classList.remove('hidden');
                document.getElementById('grid-grading').classList.add('hidden');
                document.getElementById('grid-grading').classList.remove('grid');

                // Content Logic
                const frontEl = document.getElementById('card-front-content');
                const backEl = document.getElementById('card-back-content');
                const refEl = document.getElementById('card-front-ref');

                if (this.currentCard.type === 'cloze') {
                    // Regex parse {{c1::answer}}
                    const raw = this.currentCard.front;
                    const clozeRegex = /{{c1::(.*?)}}/g;
                    frontEl.innerHTML = raw.replace(clozeRegex, '<span class="cloze-hidden" title="Think...">?</span>');
                    backEl.innerHTML = raw.replace(clozeRegex, '<span class="cloze-revealed">$1</span>');
                    refEl.innerText = "Cloze Completion";
                } else {
                    frontEl.innerText = this.currentCard.front;
                    backEl.innerText = this.currentCard.back;
                    refEl.innerText = this.currentCard.front;
                }
            },

            flipCard() {
                const cardEl = document.getElementById('study-card');
                if (cardEl.classList.contains('is-flipped')) return;

                cardEl.classList.add('is-flipped');
                document.getElementById('btn-reveal').classList.add('hidden');
                document.getElementById('grid-grading').classList.remove('hidden');
                document.getElementById('grid-grading').classList.add('grid');
            },

            rateCard(rating) {
                // Process Algorithm
                const updatedCard = Brain.process(this.currentCard, rating);
                
                // Update Store
                const idx = Store.data.cards.findIndex(c => c.id === updatedCard.id);
                Store.data.cards[idx] = updatedCard;
                Store.logReview(updatedCard.id, rating);

                // Queue Management
                this.studyQueue.shift(); // Remove current
                if (updatedCard.dueDate <= Date.now() + (20 * 60 * 1000)) { 
                    // If due soon (Again/Hard), re-queue at end
                    this.studyQueue.push(updatedCard);
                }

                // Animation out
                const cardEl = document.getElementById('study-card');
                cardEl.style.transform = "translateX(-120%) rotateY(180deg)";
                cardEl.style.opacity = "0";

                setTimeout(() => {
                    cardEl.style.transition = "none";
                    cardEl.style.transform = "translateX(100%)";
                    cardEl.style.opacity = "1";
                    
                    setTimeout(() => {
                        cardEl.style.transition = "transform 0.6s cubic-bezier(0.4, 0.0, 0.2, 1)";
                        this.loadNextCard();
                    }, 50);
                }, 300);
            },

            // --- CREATE LOGIC ---
            toggleType(type) {
                const btnBasic = document.getElementById('btn-basic');
                const btnCloze = document.getElementById('btn-cloze');
                const boxBack = document.getElementById('box-back');
                const hint = document.getElementById('hint-cloze');

                if (type === 'basic') {
                    btnBasic.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-q-primary text-white shadow transition";
                    btnCloze.className = "flex-1 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition";
                    boxBack.classList.remove('hidden');
                    hint.classList.add('hidden');
                } else {
                    btnCloze.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-q-primary text-white shadow transition";
                    btnBasic.className = "flex-1 py-2 rounded-lg text-xs font-bold text-gray-400 hover:text-white transition";
                    boxBack.classList.add('hidden');
                    hint.classList.remove('hidden');
                }
                this.createType = type;
            },

            saveCard() {
                const deckId = document.getElementById('inp-deck').value;
                const front = document.getElementById('inp-front').value;
                const back = document.getElementById('inp-back').value;
                const type = this.createType || 'basic';

                if (!front) return UI.toast("Savol yozilmadi!", "error");
                if (type === 'basic' && !back) return UI.toast("Javob yozilmadi!", "error");
                if (type === 'cloze' && !front.includes('{{c1::')) return UI.toast("Cloze format xato!", "error");

                Store.data.cards.push(Store.makeCard(deckId, front, type==='cloze'?'':back, type));
                Store.save();
                
                document.getElementById('inp-front').value = '';
                document.getElementById('inp-back').value = '';
                UI.toast("Karta Saqlandi!", "success");
            },
            
            saveDeck() {
                const name = document.getElementById('inp-deck-name').value;
                if(!name) return;
                const colors = ["from-orange-500 to-red-500", "from-green-500 to-emerald-500", "from-pink-500 to-rose-500"];
                Store.data.decks.push({
                    id: Store.id(),
                    name: name,
                    icon: "fa-folder",
                    color: colors[Math.floor(Math.random()*colors.length)]
                });
                Store.save();
                this.renderCreate(document.getElementById('viewport')); // Refresh
                UI.toast("To'plam yaratildi!", "success");
            },

            resetData() {
                if(confirm("Haqiqatan ham hamma narsani o'chirib tashlaysizmi?")) {
                    localStorage.removeItem(Store.KEY);
                    location.reload();
                }
            }
        };

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

    </script>
</body>
</html>

